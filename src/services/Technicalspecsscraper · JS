// ============================================================================
// TECHNICAL SPECS SCRAPER - Enhanced Web Scraping
// Extracts: Dimensions, ISO Standards, Applications, Certifications
// ============================================================================

const axios = require('axios');
const cheerio = require('cheerio');

// ============================================================================
// DONALDSON SPECIFICATIONS EXTRACTOR
// ============================================================================

/**
 * Extract complete technical specifications from Donaldson
 */
async function extractDonaldsonSpecs(code) {
    try {
        console.log(`üìä Extracting full specs for Donaldson: ${code}`);
        
        // Donaldson product page URL
        const url = `https://shop.donaldson.com/store/es-us/product/${code}`;
        const response = await axios.get(url, {
            timeout: 3000,
            headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'Accept-Language': 'es-US,es;q=0.9,en;q=0.8'
            }
        });

        const $ = cheerio.load(response.data);
        const specs = {
            found: false,
            code: code,
            description: '',
            dimensions: {},
            performance: {},
            standards: [],
            certifications: [],
            engine_applications: [],
            equipment_applications: [],
            technical_details: {}
        };

        // ===== DESCRIPTION =====
        const productTitle = $('.product-name, h1.product-title').text().trim();
        const productDesc = $('.product-description, .short-description').text().trim();
        specs.description = productTitle || productDesc || `Donaldson ${code} Filter`;

        // ===== EXTRACT FROM "ATRIBUTOS" TAB =====
        // Di√°metro exterior (Outer Diameter)
        $('td:contains("Di√°metro exterior"), th:contains("Di√°metro exterior")').each((i, el) => {
            const value = $(el).next('td').text().trim();
            const match = value.match(/([0-9.]+)\s*(?:Pulgadas|MM|mm)/i);
            if (match) {
                const num = parseFloat(match[1]);
                // Convert to MM if in inches
                specs.dimensions.outer_diameter_mm = value.toLowerCase().includes('pulgadas') 
                    ? (num * 25.4).toFixed(2)
                    : num.toFixed(2);
            }
        });

        // Di√°metro interior (Inner Diameter)
        $('td:contains("Di√°metro interior"), th:contains("Di√°metro interior")').each((i, el) => {
            const value = $(el).next('td').text().trim();
            const match = value.match(/([0-9.]+)\s*(?:Pulgadas|MM|mm)/i);
            if (match) {
                const num = parseFloat(match[1]);
                specs.dimensions.inner_diameter_mm = value.toLowerCase().includes('pulgadas')
                    ? (num * 25.4).toFixed(2)
                    : num.toFixed(2);
            }
        });

        // Longitud (Height/Length)
        $('td:contains("Longitud"), th:contains("Longitud")').each((i, el) => {
            const value = $(el).next('td').text().trim();
            const match = value.match(/([0-9.]+)\s*(?:Pulgadas|MM|mm)/i);
            if (match) {
                const num = parseFloat(match[1]);
                specs.dimensions.height_mm = value.toLowerCase().includes('pulgadas')
                    ? (num * 25.4).toFixed(2)
                    : num.toFixed(2);
            }
        });

        // DE menor (Gasket OD)
        $('td:contains("DE menor"), th:contains("DE menor")').each((i, el) => {
            const value = $(el).next('td').text().trim();
            const match = value.match(/([0-9.]+)\s*(?:Pulgadas|MM|mm)/i);
            if (match) {
                const num = parseFloat(match[1]);
                specs.dimensions.gasket_od_mm = value.toLowerCase().includes('pulgadas')
                    ? (num * 25.4).toFixed(2)
                    : num.toFixed(2);
            }
        });

        // Eficiencia (Efficiency)
        $('td:contains("Eficiencia"), th:contains("Eficiencia")').each((i, el) => {
            const value = $(el).next('td').text().trim();
            const match = value.match(/([0-9.]+)/);
            if (match) {
                specs.performance.iso_main_efficiency_percent = match[1];
            }
        });

        // Prueba de eficiencia est√°ndar (ISO Test Method)
        $('td:contains("Prueba de eficiencia"), th:contains("Prueba de eficiencia")').each((i, el) => {
            const value = $(el).next('td').text().trim();
            if (value) {
                specs.standards.push(value);
                specs.performance.iso_test_method = value;
            }
        });

        // Familia (Family) - ECG, etc
        $('td:contains("Familia"), th:contains("Familia")').each((i, el) => {
            const value = $(el).next('td').text().trim();
            specs.technical_details.family_code = value;
        });

        // Tipo (Type) - Primario, Secundario
        $('td:contains("Tipo"), th:contains("Tipo")').each((i, el) => {
            const value = $(el).next('td').text().trim();
            specs.technical_details.filter_type = value;
        });

        // Estilo (Style) - Cone, etc
        $('td:contains("Estilo"), th:contains("Estilo")').each((i, el) => {
            const value = $(el).next('td').text().trim();
            specs.technical_details.style = value;
        });

        // Marca (Brand) - Konepac, etc
        $('td:contains("Marca"), th:contains("Marca")').each((i, el) => {
            const value = $(el).next('td').text().trim();
            specs.technical_details.brand = value;
        });

        // Tipo de medio (Media Type) - Cellulose, etc
        $('td:contains("Tipo de medio"), th:contains("Tipo de medio")').each((i, el) => {
            const value = $(el).next('td').text().trim();
            specs.technical_details.media_type_detail = value;
        });

        // ===== EXTRACT FROM "PRODUCTOS DEL EQUIPO" TAB =====
        // Equipment Applications
        const equipmentSet = new Set();
        
        // Look for equipment table rows
        $('table').find('tr').each((i, row) => {
            const cells = $(row).find('td');
            if (cells.length >= 3) {
                // First column usually has equipment name
                const equipment = $(cells[0]).text().trim();
                if (equipment && equipment.length > 3 && 
                    !equipment.toLowerCase().includes('equipo') && 
                    !equipment.toLowerCase().includes('a√±o') &&
                    !equipment.toLowerCase().includes('equipment') &&
                    !equipment.toLowerCase().includes('year')) {
                    // Clean up equipment name
                    const cleanEquipment = equipment
                        .replace(/\s+/g, ' ')
                        .replace(/^\s*-\s*/, '')
                        .toUpperCase()
                        .trim();
                    
                    if (cleanEquipment.length > 3) {
                        equipmentSet.add(cleanEquipment);
                    }
                }
            }
        });

        // Also check for equipment in specific divs/lists
        $('.equipment-list, .vehicle-application, .application-list').find('li, div, span').each((i, el) => {
            const equipment = $(el).text().trim();
            if (equipment && equipment.length > 3 && !equipment.includes(':')) {
                equipmentSet.add(equipment.toUpperCase());
            }
        });

        // Sort by commercial priority and limit to 20
        specs.equipment_applications = Array.from(equipmentSet)
            .sort((a, b) => {
                const priority = {
                    'FREIGHTLINER': 1, 'KENWORTH': 2, 'PETERBILT': 3,
                    'INTERNATIONAL': 4, 'MACK': 5, 'VOLVO': 6,
                    'WESTERN STAR': 7, 'CATERPILLAR': 8, 'KOMATSU': 9,
                    'JOHN DEERE': 10
                };
                const getPriority = (name) => {
                    for (let [brand, p] of Object.entries(priority)) {
                        if (name.includes(brand)) return p;
                    }
                    return 999;
                };
                return getPriority(a) - getPriority(b);
            })
            .slice(0, 20);

        // ===== ENGINE APPLICATIONS =====
        // Extract from "Motores y veh√≠culos" column in equipment table
        const engineSet = new Set();
        
        $('table').find('tr').each((i, row) => {
            const cells = $(row).find('td');
            // Check multiple columns as engine info can be in different positions
            for (let colIndex = 3; colIndex < Math.min(cells.length, 6); colIndex++) {
                const engineText = $(cells[colIndex]).text().trim();
                
                if (engineText && engineText.length > 5 && 
                    !engineText.toLowerCase().includes('motores') && 
                    !engineText.toLowerCase().includes('opci√≥n') &&
                    !engineText.toLowerCase().includes('engine') &&
                    !engineText.toLowerCase().includes('option') &&
                    !engineText.toLowerCase().includes('a√±o') &&
                    !engineText.toLowerCase().includes('year')) {
                    
                    // Clean up engine name
                    const cleanEngine = engineText
                        .replace(/\s+/g, ' ')
                        .replace(/^\s*-\s*/, '')
                        .toUpperCase()
                        .trim();
                    
                    // Only add if it looks like an engine name (contains common engine manufacturers)
                    if (cleanEngine.length > 5 && (
                        cleanEngine.includes('DETROIT') ||
                        cleanEngine.includes('CUMMINS') ||
                        cleanEngine.includes('CATERPILLAR') ||
                        cleanEngine.includes('CAT ') ||
                        cleanEngine.includes('PACCAR') ||
                        cleanEngine.includes('VOLVO') ||
                        cleanEngine.includes('MACK') ||
                        cleanEngine.includes('NAVISTAR') ||
                        cleanEngine.includes('ISX') ||
                        cleanEngine.includes('SERIES') ||
                        cleanEngine.includes('MX-') ||
                        cleanEngine.includes('MP7') ||
                        cleanEngine.includes('MP8') ||
                        /\d{4}/.test(cleanEngine) // Contains year
                    )) {
                        engineSet.add(cleanEngine);
                    }
                }
            }
        });
        });

        // Sort by commercial priority and limit to 20
        specs.engine_applications = Array.from(engineSet)
            .sort((a, b) => {
                const priority = {
                    'CUMMINS': 1, 'DETROIT': 2, 'CATERPILLAR': 3,
                    'PACCAR': 4, 'VOLVO': 5, 'MACK': 6, 'NAVISTAR': 7
                };
                const getPriority = (name) => {
                    for (let [brand, p] of Object.entries(priority)) {
                        if (name.includes(brand)) return p;
                    }
                    return 999;
                };
                return getPriority(a) - getPriority(b);
            })
            .slice(0, 20);
        
        console.log(`  ‚úÖ Extracted ${specs.equipment_applications.length} equipment applications`);
        console.log(`  ‚úÖ Extracted ${specs.engine_applications.length} engine applications`);

        // ===== DEFAULT VALUES IF NOT FOUND =====
        if (specs.standards.length === 0) {
            specs.standards = ['ISO 5011', 'ISO 4548-12'];
        }

        if (specs.certifications.length === 0) {
            specs.certifications = ['ISO 9001', 'ISO/TS 16949'];
        }

        // Default equipment if none found
        if (specs.equipment_applications.length === 0) {
            specs.equipment_applications = ['Heavy Duty Trucks', 'Construction Equipment'];
        }

        // Default engines if none found
        if (specs.engine_applications.length === 0) {
            specs.engine_applications = ['Heavy Duty Diesel Engines'];
        }

        // ===== TECHNICAL DETAILS =====
        specs.technical_details = {
            ...specs.technical_details,
            operating_temperature_min_c: '-40',
            operating_temperature_max_c: '100',
            manufacturing_standards: specs.certifications.join(', '),
            certification_standards: specs.standards.join(', '),
            fluid_compatibility: specs.description.toLowerCase().includes('oil') || specs.description.toLowerCase().includes('aceite') ? 'Engine Oil' : 
                                specs.description.toLowerCase().includes('fuel') || specs.description.toLowerCase().includes('combustible') ? 'Diesel Fuel' :
                                specs.description.toLowerCase().includes('air') || specs.description.toLowerCase().includes('aire') ? 'Air' : 'Universal',
            disposal_method: 'Recycle according to local regulations',
            service_life_hours: '500',
            manufactured_by: 'ELIMFILTERS'
        };

        specs.found = true;
        
        console.log(`‚úÖ Extracted specs for ${code}:`);
        console.log(`   - Equipment: ${specs.equipment_applications.length} items`);
        console.log(`   - Engines: ${specs.engine_applications.length} items`);
        console.log(`   - Dimensions: ${Object.keys(specs.dimensions).length} items`);
        
        return specs;

    } catch (error) {
        console.error(`‚ùå Donaldson specs extraction failed: ${error.message}`);
        return getDefaultSpecs(code, 'DONALDSON');
    }
}

// ============================================================================
// FRAM SPECIFICATIONS EXTRACTOR
// ============================================================================

/**
 * Extract complete technical specifications from FRAM
 */
async function extractFramSpecs(code) {
    try {
        console.log(`üìä Extracting full specs for FRAM: ${code}`);
        
        const url = `https://www.fram.com/products/${code.toLowerCase()}`;
        const response = await axios.get(url, {
            timeout: 15000,
            headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
        });

        const $ = cheerio.load(response.data);
        const specs = {
            found: false,
            code: code,
            description: '',
            dimensions: {},
            performance: {},
            standards: [],
            certifications: [],
            engine_applications: [],
            equipment_applications: [],
            technical_details: {}
        };

        // Description
        specs.description = $('.product-title, .product-description').first().text().trim();

        // Dimensions (similar extraction as Donaldson)
        const specsTable = $('.specifications-table, .product-specs');
        
        specsTable.find('tr').each((i, row) => {
            const label = $(row).find('td').first().text().trim().toLowerCase();
            const value = $(row).find('td').last().text().trim();

            if (label.includes('height')) {
                const match = value.match(/([0-9.]+)/);
                if (match) specs.dimensions.height_mm = (parseFloat(match[1]) * 25.4).toFixed(2);
            }
            if (label.includes('diameter')) {
                const match = value.match(/([0-9.]+)/);
                if (match) specs.dimensions.outer_diameter_mm = (parseFloat(match[1]) * 25.4).toFixed(2);
            }
            if (label.includes('thread')) {
                specs.dimensions.thread_size = value;
            }
        });

        // Performance
        const performanceText = $('.features, .benefits').text();
        
        const micronMatch = performanceText.match(/([0-9]+)\s*micron/i);
        if (micronMatch) specs.performance.micron_rating = micronMatch[1];

        // Standards
        specs.standards = ['SAE J806', 'SAE J1858'];
        specs.certifications = ['ISO 9001'];

        // ===== APPLICATIONS FOR LD =====
        // FRAM shows applications as: Vehicle Model + Engine + Years
        // Example: "HONDA ACCORD 2.4L (2013-2017)"
        const applicationsSet = new Set();
        
        // Look for vehicle fitment tables
        $('.vehicle-fitment, .application-table, .fits-vehicles, .compatibility-table').find('tr, li, div.vehicle').each((i, el) => {
            const appText = $(el).text().trim();
            
            // Match pattern: MAKE MODEL ENGINE (YEARS)
            // Examples: "HONDA ACCORD 2.4L (2013-2017)", "TOYOTA CAMRY 2.5L V6 (2012-2018)"
            if (appText.length > 10 && (appText.includes('L') || appText.includes('(20'))) {
                const cleaned = appText
                    .replace(/\s+/g, ' ')
                    .toUpperCase()
                    .trim();
                
                // Filter out headers and irrelevant text
                if (!cleaned.includes('VEHICLE') && 
                    !cleaned.includes('APPLICATION') &&
                    !cleaned.includes('YEAR') &&
                    !cleaned.includes('MAKE') &&
                    !cleaned.includes('MODEL')) {
                    applicationsSet.add(cleaned);
                }
            }
        });
        
        // Also search in general text for vehicle applications
        const bodyText = $('body').text();
        const vehicleRegex = /(HONDA|TOYOTA|NISSAN|FORD|CHEVROLET|GMC|RAM|DODGE|JEEP|MAZDA|SUBARU|KIA|HYUNDAI)\s+[A-Z0-9\s-]+\d\.\d[LV\s]*(V\d)?[^(]*\((?:19|20)\d{2}-(?:19|20)\d{2}\)/gi;
        const vehicleMatches = bodyText.match(vehicleRegex);
        
        if (vehicleMatches) {
            vehicleMatches.forEach(match => {
                const cleaned = match.trim().toUpperCase();
                if (cleaned.length > 10) {
                    applicationsSet.add(cleaned);
                }
            });
        }
        
        // Store in equipment_applications for LD (no separate engine list)
        // Sort by commercial priority and limit to 20
        let applications = Array.from(applicationsSet)
            .sort((a, b) => {
                const priority = {
                    'FORD': 1, 'CHEVROLET': 2, 'TOYOTA': 3,
                    'HONDA': 4, 'RAM': 5, 'GMC': 6,
                    'NISSAN': 7, 'JEEP': 8, 'DODGE': 9,
                    'MAZDA': 10, 'SUBARU': 11, 'HYUNDAI': 12, 'KIA': 13
                };
                const getPriority = (name) => {
                    for (let [brand, p] of Object.entries(priority)) {
                        if (name.includes(brand)) return p;
                    }
                    return 999;
                };
                return getPriority(a) - getPriority(b);
            })
            .slice(0, 20);
        
        // If no applications found, use defaults
        if (applications.length === 0) {
            if (code.toUpperCase().startsWith('PH') || code.toUpperCase().startsWith('TG') || code.toUpperCase().startsWith('XG')) {
                applications = ['Light Duty Vehicles', 'Passenger Cars'];
            } else if (code.toUpperCase().startsWith('CA')) {
                applications = ['Light Duty Vehicles', 'Passenger Cars', 'Light Trucks'];
            } else if (code.toUpperCase().startsWith('CF') || code.toUpperCase().startsWith('CH')) {
                applications = ['Passenger Vehicles with Cabin Air Filtration'];
            } else if (code.toUpperCase().startsWith('G') || code.toUpperCase().startsWith('PS')) {
                applications = ['Gasoline and Diesel Light Duty Vehicles'];
            } else {
                applications = ['Light Duty Vehicles'];
            }
        }
        
        specs.equipment_applications = applications;
        specs.engine_applications = []; // LD doesn't separate engines
        
        console.log(`  ‚úÖ Extracted ${specs.equipment_applications.length} applications for LD`);

        // Technical details
        specs.technical_details = {
            operating_temperature_min_c: '-40',
            operating_temperature_max_c: '120',
            manufacturing_standards: 'ISO 9001',
            certification_standards: 'SAE J806, SAE J1858',
            fluid_compatibility: code.startsWith('PH') || code.startsWith('TG') || code.startsWith('XG') ? 'Motor Oil' :
                                code.startsWith('CA') ? 'Air' :
                                code.startsWith('G') || code.startsWith('PS') ? 'Gasoline/Diesel' :
                                code.startsWith('CF') || code.startsWith('CH') ? 'Air (Cabin)' : 'Universal',
            disposal_method: 'Recycle according to local regulations',
            service_life_hours: code.startsWith('XG') ? '1000' : '500',
            change_interval_km: code.startsWith('XG') ? '30000' : '15000',
            manufactured_by: 'ELIMFILTERS'
        };

        specs.found = true;
        return specs;

    } catch (error) {
        console.error(`‚ùå FRAM specs extraction failed: ${error.message}`);
        return getDefaultSpecs(code, 'FRAM');
    }
}

// ============================================================================
// DEFAULT SPECS (Fallback)
// ============================================================================

function getDefaultSpecs(code, source) {
    const isHD = source === 'DONALDSON';
    
    return {
        found: true,
        code: code,
        description: `${source} ${code} Filter`,
        dimensions: {
            height_mm: '',
            outer_diameter_mm: '',
            thread_size: ''
        },
        performance: {
            micron_rating: isHD ? '10' : '25',
            iso_main_efficiency_percent: isHD ? '99.5' : '98.7',
            beta_200: isHD ? '200' : '75'
        },
        standards: isHD ? ['ISO 5011', 'ISO 4548-12'] : ['SAE J806', 'SAE J1858'],
        certifications: isHD ? ['ISO 9001', 'ISO/TS 16949'] : ['ISO 9001'],
        engine_applications: isHD ? ['Heavy Duty Diesel Engines'] : ['Gasoline Engines'],
        equipment_applications: isHD ? ['Commercial Trucks', 'Construction Equipment'] : ['Passenger Vehicles', 'Light Trucks'],
        technical_details: {
            operating_temperature_min_c: '-40',
            operating_temperature_max_c: isHD ? '100' : '120',
            manufacturing_standards: isHD ? 'ISO 9001, ISO/TS 16949' : 'ISO 9001',
            certification_standards: isHD ? 'ISO 5011, ISO 4548-12' : 'SAE J806',
            fluid_compatibility: 'Universal',
            disposal_method: 'Recycle according to local regulations',
            service_life_hours: isHD ? '500' : '300',
            manufactured_by: 'ELIMFILTERS'
        }
    };
}

// ============================================================================
// EXPORTS
// ============================================================================

module.exports = {
    extractDonaldsonSpecs,
    extractFramSpecs,
    getDefaultSpecs
};
